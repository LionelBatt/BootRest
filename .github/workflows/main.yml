name: Travel Agency CI/CD with Maven and EC2 Deployment

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: eu-west-3
  S3_BUCKET: prod-resto
  EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
  APP_VERSION: 1.0.1-SNAPSHOT

jobs:
  test:
    runs-on: ubuntu-latest
    name: Tests et QualitÃ© du Code
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4

    - name: â˜• Configuration JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: ğŸ“¦ Cache des dÃ©pendances Maven
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: ğŸ§ª ExÃ©cution des tests
      run: mvn -B test --file pom.xml
      
  build:
    runs-on: ubuntu-latest
    needs: test
    name: Construction de l'application
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4

    - name: â˜• Configuration JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: ğŸ“¦ Cache des dÃ©pendances Maven
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: ğŸ”¨ Construction avec Maven
      run: mvn -B package -DskipTests --file pom.xml

    - name: ğŸ“‹ VÃ©rification de l'artifact
      run: |
        ls -la target/
        echo "JAR crÃ©Ã©: $(ls target/*.jar | grep -v original)"

    - name: ğŸ’¾ Sauvegarde de l'artifact
      uses: actions/upload-artifact@v4
      with:
        name: travel-agency-jar
        path: target/travel-agency-${{ env.APP_VERSION }}.jar
        retention-days: 30

  deploy:
    runs-on: ubuntu-latest
    needs: build
    name: DÃ©ploiement sur EC2
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4

    - name: ğŸ“¦ RÃ©cupÃ©ration de l'artifact
      uses: actions/download-artifact@v4
      with:
        name: travel-agency-jar
        path: ./

    - name: ğŸ”§ Configuration des credentials AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ğŸ”‘ Configuration de la clÃ© SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H $(aws ec2 describe-instances --instance-ids ${{ env.EC2_INSTANCE_ID }} --query 'Reservations[0].Instances[0].PublicIpAddress' --output text) >> ~/.ssh/known_hosts

    - name: ğŸ“¤ Upload vers S3
      run: |
        # Upload du JAR et Dockerfile
        aws s3 cp travel-agency-${{ env.APP_VERSION }}.jar s3://${{ env.S3_BUCKET }}/app/
        aws s3 cp Dockerfile s3://${{ env.S3_BUCKET }}/app/
        
        echo "âœ… Fichiers uploadÃ©s vers S3"

    - name: ğŸš€ DÃ©ploiement sur EC2
      run: |
        # RÃ©cupÃ©rer l'IP publique de l'instance EC2
        EC2_IP=$(aws ec2 describe-instances \
          --instance-ids ${{ env.EC2_INSTANCE_ID }} \
          --query 'Reservations[0].Instances[0].PublicIpAddress' \
          --output text)
        
        echo "ğŸŒ IP de l'instance EC2: $EC2_IP"
        echo "ğŸ”‘ DÃ©ploiement via SSH..."
        
        # CrÃ©er un script de dÃ©ploiement simplifiÃ©
        cat > deploy_direct.sh << 'EOF'
        #!/bin/bash
        set -e
        
        # Configuration
        APP_NAME="travel-agency"
        CONTAINER_NAME="travel-agency-app"
        IMAGE_NAME="travel-agency:latest"
        APP_DIR="/opt/travel-agency"
        S3_BUCKET="prod-resto"
        AWS_REGION="eu-west-3"
        
        echo "ğŸš€ DÃ©but du dÃ©ploiement direct..."
        
        # CrÃ©er les rÃ©pertoires
        sudo mkdir -p "$APP_DIR"
        cd "$APP_DIR"
        
        # ArrÃªter le conteneur existant
        if docker ps -q -f name="$CONTAINER_NAME" | grep -q .; then
            echo "ğŸ›‘ ArrÃªt du conteneur existant..."
            docker stop "$CONTAINER_NAME" || true
            docker rm "$CONTAINER_NAME" || true
        fi
        
        # TÃ©lÃ©charger les fichiers directement
        echo "ğŸ“¥ TÃ©lÃ©chargement des fichiers..."
        sudo curl -o ./Dockerfile "https://s3.$AWS_REGION.amazonaws.com/$S3_BUCKET/app/Dockerfile"
        sudo curl -o ./travel-agency-1.0.1-SNAPSHOT.jar "https://s3.$AWS_REGION.amazonaws.com/$S3_BUCKET/app/travel-agency-1.0.1-SNAPSHOT.jar"
        
        # VÃ©rifier les tÃ©lÃ©chargements
        if [[ ! -f "./Dockerfile" ]] || [[ ! -f "./travel-agency-1.0.1-SNAPSHOT.jar" ]]; then
            echo "âŒ Erreur de tÃ©lÃ©chargement"
            exit 1
        fi
        
        # Construire et dÃ©marrer
        echo "ğŸ”¨ Construction de l'image Docker..."
        sudo docker build -t "$IMAGE_NAME" .
        
        echo "ğŸš€ DÃ©marrage du conteneur..."
        sudo docker run -d \
            --name "$CONTAINER_NAME" \
            --restart unless-stopped \
            -p 8080:8080 \
            "$IMAGE_NAME"
        
        echo "âœ… DÃ©ploiement terminÃ©"
        EOF
        
        chmod +x deploy_direct.sh
        
        # Copier et exÃ©cuter via SSH
        scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no deploy_direct.sh ubuntu@$EC2_IP:/tmp/
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@$EC2_IP "chmod +x /tmp/deploy_direct.sh && /tmp/deploy_direct.sh"
        
        echo "ğŸ‰ DÃ©ploiement terminÃ© avec succÃ¨s !"

    - name: ğŸ¥ VÃ©rification de santÃ© de l'application
      run: |
        # RÃ©cupÃ©rer l'IP publique de l'instance EC2
        EC2_IP=$(aws ec2 describe-instances \
          --instance-ids ${{ env.EC2_INSTANCE_ID }} \
          --query 'Reservations[0].Instances[0].PublicIpAddress' \
          --output text)
        
        echo "ğŸŒ IP de l'instance EC2: $EC2_IP"
        
        # Attendre que l'application soit prÃªte
        echo "â³ VÃ©rification de la santÃ© de l'application..."
        for i in {1..30}; do
          if curl -f "http://$EC2_IP:8080/travel/api/test/all" > /dev/null 2>&1; then
            echo "âœ… Application Docker accessible et fonctionnelle !"
            echo "ğŸŒ URL: http://$EC2_IP:8080/travel"
            echo "ğŸ“š Swagger: http://$EC2_IP:8080/travel/swagger-ui/index.html"
            echo "ğŸ³ Container status: $(ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@$EC2_IP 'docker ps -f name=travel-agency-app --format "table {{.Names}}\t{{.Status}}"')"
            exit 0
          fi
          echo "â³ Tentative $i/30..."
          sleep 10
        done
        
        echo "âŒ L'application ne rÃ©pond pas aprÃ¨s 5 minutes"
        echo "ğŸ” Status du container:"
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@$EC2_IP 'docker ps -a && docker logs travel-agency-app --tail 20'
        exit 1
